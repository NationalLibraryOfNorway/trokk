name: "Setup sccache"
description: "Installs sccache for caching Rust builds"
inputs:
  version:
    description: "Sccache version"
    required: false
    default: "0.12.0"
  s3-host:
    description: "S3 endpoint for sccache (e.g. https://s3.example.com)"
    required: false
  s3-access-key:
    description: "S3 access key for sccache"
    required: false
  s3-secret-key:
    description: "S3 secret key for sccache"
    required: false
  s3-bucket:
    description: "S3 bucket for sccache"
    required: false

runs:
  using: "composite"
  steps:
    - name: "Check for existing sccache"
      id: check
      shell: powershell
      run: |
        if (Get-Command sccache -ErrorAction SilentlyContinue) {
          Write-Host "sccache already installed"
          "installed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } else {
          "installed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } 

    - name: "Install sccache"
      if: steps.check.outputs.installed != 'true'
      env:
        SCCACHE_VERSION: ${{ inputs.version }}
      shell: powershell
      run: |
        $ErrorActionPreference = "Stop"

        $v = $env:SCCACHE_VERSION
        $url = "https://github.com/mozilla/sccache/releases/download/v$v/sccache-v$v-x86_64-pc-windows-msvc.zip"
        $zip = "$env:RUNNER_TEMP\sccache-$v.zip"
        $destRoot = "$env:RUNNER_TEMP\sccache"

        if (Test-Path $destRoot) { Remove-Item $destRoot -Recurse -Force }
        New-Item -ItemType Directory -Path $destRoot | Out-Null

        Invoke-WebRequest $url -OutFile $zip
        Expand-Archive -LiteralPath $zip -DestinationPath $destRoot -Force

        # Find sccache.exe regardless of archive layout
        $sccacheExe = Get-ChildItem -Path $destRoot -Recurse -Filter "sccache.exe" | Select-Object -First 1
        if (-not $sccacheExe) {
          Write-Host "Could not find sccache.exe under: $destRoot"
          Get-ChildItem -Path $destRoot -Recurse | Select-Object FullName | Format-Table -AutoSize
          throw "sccache.exe not found after extracting archive"
        }

        # Copy into a short, stable dir to avoid Windows long-path issues
        $binDir = "$env:RUNNER_TEMP\bin\sccache"
        if (Test-Path $binDir) { Remove-Item $binDir -Recurse -Force }
        New-Item -ItemType Directory -Path $binDir | Out-Null

        $binExe = Join-Path $binDir 'sccache.exe'
        Copy-Item -LiteralPath $sccacheExe.FullName -Destination $binExe -Force

        # IMPORTANT: write to GITHUB_PATH, not env:Path.
        # GITHUB_PATH affects subsequent steps, not necessarily the current step.
        $binDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # Verify in the same step using absolute path (so we don't depend on PATH update timing)
        & $binExe --version

    - name: "Configure sccache env (S3 backend)"
      shell: powershell
      env:
        S3_BUCKET: ${{ inputs.s3-bucket }}
        S3_HOST: ${{ inputs.s3-host }}
        S3_ACCESS_KEY: ${{ inputs.s3-access-key }}
        S3_SECRET_KEY: ${{ inputs.s3-secret-key }}
      run: |
        # Rust: use sccache as compiler wrapper (may be disabled later if connectivity check fails)
        Add-Content -Path $env:GITHUB_ENV -Value "RUSTC_WRAPPER=sccache"

        # Optional but commonly recommended for CI: incremental builds aren't cacheable by sccache
        Add-Content -Path $env:GITHUB_ENV -Value "CARGO_INCREMENTAL=0"

        # Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_CACHE_SIZE=5G"
        Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_S3_ENABLE_VIRTUAL_HOST_STYLE=false"
        Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_REGION=auto"
        Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_S3_USE_SSL=true"
        # Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_S3_KEY_PREFIX=cmake-sccache"
        Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_LOG=info"

        Add-Content -Path $env:GITHUB_ENV -Value "CMAKE_C_COMPILER_LAUNCHER=sccache"
        Add-Content -Path $env:GITHUB_ENV -Value "CMAKE_CXX_COMPILER_LAUNCHER=sccache"

        # Configure S3 backend
        if ($env:S3_BUCKET) { Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_BUCKET=$env:S3_BUCKET" }
        if ($env:S3_HOST) { Add-Content -Path $env:GITHUB_ENV -Value "SCCACHE_ENDPOINT=$env:S3_HOST" }
        if ($env:S3_ACCESS_KEY) { Add-Content -Path $env:GITHUB_ENV -Value "AWS_ACCESS_KEY_ID=$env:S3_ACCESS_KEY" }
        if ($env:S3_SECRET_KEY) { Add-Content -Path $env:GITHUB_ENV -Value "AWS_SECRET_ACCESS_KEY=$env:S3_SECRET_KEY" }

    - name: "Check sccache backend connectivity (disable wrapper on failure)"
      shell: powershell
      run: |
        $ErrorActionPreference = 'Continue'

        if (-not (Get-Command sccache -ErrorAction SilentlyContinue)) {
          Write-Host 'WARNING: sccache not found on PATH; disabling RUSTC_WRAPPER.'
          Add-Content -Path $env:GITHUB_ENV -Value 'RUSTC_WRAPPER='
          Add-Content -Path $env:GITHUB_ENV -Value 'SCCACHE_ENABLED=false'
          exit 0
        }

        # This forces sccache to initialize the backend and touch the bucket (it accesses .sccache_check).
        # If the runner is behind a proxy that can't tunnel to the endpoint, this will fail quickly.
        sccache --show-stats 2>$null | Out-Null

        if ($LASTEXITCODE -ne 0) {
          Write-Host 'WARNING: sccache backend not reachable (proxy/endpoint/permissions). Disabling RUSTC_WRAPPER.'
          Add-Content -Path $env:GITHUB_ENV -Value 'RUSTC_WRAPPER='
          Add-Content -Path $env:GITHUB_ENV -Value 'SCCACHE_ENABLED=false'
          exit 0
        }

        Add-Content -Path $env:GITHUB_ENV -Value 'SCCACHE_ENABLED=true'
        Write-Host 'sccache backend reachable'

    - name: "Start sccache server"
      shell: powershell
      run: |
        $ErrorActionPreference = 'Continue'

        if ($env:SCCACHE_ENABLED -ne 'true') {
          Write-Host 'Skipping sccache server start (disabled)'
          exit 0
        }

        if (-not (Get-Command sccache -ErrorAction SilentlyContinue)) {
          Write-Host "sccache is not on PATH. PATH is:"
          Write-Host $env:PATH
          Add-Content -Path $env:GITHUB_ENV -Value 'RUSTC_WRAPPER='
          exit 0
        }

        sccache --start-server

